#!/usr/bin/env bash
set -e

echo "üöÄ Iniciando despliegue de Paladino Propiedades..."

echo "üì• Actualizando c√≥digo desde el repositorio..."
git pull

echo "üì¶ Instalando dependencias de producci√≥n..."
npm ci --omit=dev

echo "üî® Construyendo la aplicaci√≥n..."
npm run build

echo "üîÑ Recargando aplicaci√≥n con PM2..."
if command -v pm2 &> /dev/null; then
    # Verificar si el proceso existe
    if pm2 list | grep -q "paladino"; then
        pm2 reload paladino
        echo "‚úÖ Aplicaci√≥n recargada con PM2"
    else
        echo "‚ö†Ô∏è  Proceso no encontrado. Iniciando aplicaci√≥n con PM2..."
        if [ -f "ecosystem.config.cjs" ]; then
            pm2 start ecosystem.config.cjs
        elif [ -f "ecosystem.config.js" ]; then
            pm2 start ecosystem.config.js
        else
            pm2 start npm --name "paladino" -- start
        fi
        echo "‚úÖ Aplicaci√≥n iniciada con PM2"
    fi
else
    echo "‚ö†Ô∏è  PM2 no est√° instalado. Instalando PM2 globalmente..."
    npm install -g pm2
    echo "üîÑ Iniciando aplicaci√≥n con PM2..."
    if [ -f "ecosystem.config.cjs" ]; then
        pm2 start ecosystem.config.cjs
    elif [ -f "ecosystem.config.js" ]; then
        pm2 start ecosystem.config.js
    else
        pm2 start npm --name "paladino" -- start
    fi
    echo "‚úÖ Aplicaci√≥n iniciada con PM2"
fi

echo "‚úÖ Despliegue completado exitosamente!"
echo "üåê La aplicaci√≥n est√° disponible en: http://localhost:3000"
